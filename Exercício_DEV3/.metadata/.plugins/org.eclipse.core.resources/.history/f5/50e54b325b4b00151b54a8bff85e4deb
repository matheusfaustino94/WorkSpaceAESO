package br.aeso.ex01Maurício.exercício.repositorio;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

import br.aeso.ex01Maurício.exercício.exceptions.projetoException;
import br.aeso.ex01Maurício.exercício.modelo.Fornecedor;
import br.aeso.ex01Maurício.exercício.util.JDBCConnection;

public class RepositorioFornecedorJDBC implements IRepositorio<Fornecedor> {

	private Connection conexaoBD;

	public RepositorioFornecedorJDBC() {
		conexaoBD = JDBCConnection.getConnection();
	}

	@Override
	public void cadastrar(Fornecedor entity) throws projetoException {

		String sqlInsert = "insert into projeto01.fornecedor (nome, cpf, banco) values (?,?,?)";

		try {

			if (this.existe(entity.getCpf())) {
				throw new projetoException("Fornecedor já existe!");
			}

			PreparedStatement pStatement = conexaoBD.prepareStatement(
					sqlInsert, Statement.RETURN_GENERATED_KEYS);
			pStatement.setString(1, entity.getNome());
			pStatement.setString(2, entity.getCpf());
			pStatement.setString(3, entity.getBanco());
			pStatement.execute();

			ResultSet rSet = pStatement.getGeneratedKeys();
			Integer fornecedor_id = 0;

			while (rSet.next()) {
				fornecedor_id = rSet.getInt(1);
			}

			entity.setID(fornecedor_id);

			pStatement.close();
			rSet.close();
			conexaoBD.close();

		} catch (SQLException e) {
			e.printStackTrace();
		}
	}

	
	@SuppressWarnings("null")
	@Override
	public Fornecedor procurar(Integer id) throws projetoException {

		String sqlConsulta = "select * from projeto01.fornecedor where fornecedor_id = '"
				+ id + "'";

		try {
			PreparedStatement pStatement = conexaoBD.prepareStatement(sqlConsulta);
			ResultSet rSet = pStatement.executeQuery();
			
			if (rSet != null && rSet.next()) {
				String nome = rSet.getString("nome");
				String cpf = rSet.getString("cpf");
				String banco = rSet.getString("banco");
				
				Fornecedor fornecedorEncontrado = new Fornecedor();
				fornecedorEncontrado.setNome(nome);
				fornecedorEncontrado.setCpf(cpf);
				fornecedorEncontrado.setBanco(banco);
				
				return fornecedorEncontrado;
			}
		
			pStatement.close();
			rSet.close();
			conexaoBD.close();
			
		} catch (SQLException e) {
			e.printStackTrace();
		}

		return null;
	}

	@Override
	public boolean remover(Integer id) throws projetoException {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public void atualizar(Fornecedor entity) throws projetoException {
		// TODO Auto-generated method stub

	}

	@Override
	public ArrayList<Fornecedor> listarEntities() throws projetoException {
		// TODO Auto-generated method stub
		return null;
	}

	private boolean existe(String cpf) throws SQLException {
		PreparedStatement prepStatment = null;
		ResultSet consultaBD = null;
		String id_fornecedor = null;

		String sql = "select fornecedor_id from projeto01.fornecedor where cpf = '"
				+ cpf + "'";

		prepStatment = conexaoBD.prepareStatement(sql);
		consultaBD = prepStatment.executeQuery();

		while (consultaBD.next()) {
			id_fornecedor = consultaBD.getString(1);
		}

		if (id_fornecedor.equals(null)) {
			return false;
		}
		return true;
	}

}
